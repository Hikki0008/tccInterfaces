<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgeCare - Agendamento</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assents/css/Agendamento.css">
    <style>
        /* Estilos para a classe 'selected' que o JavaScript adiciona */
        .date-item.selected, .time-item.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .service-type-card.selected {
            border: 2px solid #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
        }
    </style>
</head>
<body>
<header class="header">
    <div class="container header-content">
        <div class="logo-container">
            <i class="fas fa-heartbeat logo-icon"></i>
            <h1 class="logo-text">AgeCare</h1>
        </div>
        <nav class="nav">
            <ul>
                <li><a href="#" title="In√≠cio"><i class="fas fa-home"></i></a></li>
                <li><a href="#" title="Agendamentos"><i class="fas fa-calendar-alt"></i></a></li>
                <li><a href="#" title="Favoritos"><i class="fas fa-heart"></i></a></li>
                <li><a href="#" title="Mensagens"><i class="fas fa-comments"></i></a></li>
                <li><a href="#" title="Notifica√ß√µes"><i class="fas fa-bell"></i></a></li>
                <li><a href="#" title="Minha Conta"><i class="fas fa-user-circle"></i></a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="main-content">
    <div class="container">

        <div class="service-details-card" id="professional-card">
            <!-- O card do profissional continua o mesmo -->
            <div class="service-image">
                <img id="professional-image" src="https://via.placeholder.com/300x200?text=Carregando..." alt="Foto do Profissional">
            </div>
            <div class="service-info">
                <h2 id="professional-name">Carregando...</h2>
                <p class="service-meta">
                    <span id="professional-specialty"><i class="fas fa-user-md"></i> Carregando...</span> <br>
                    <span id="professional-location"><i class="fas fa-map-marker-alt"></i> Carregando...</span> <br>
                    <span id="professional-registry"><i class="fas fa-id-card"></i> Carregando...</span> <br>
                    <span id="professional-rating"><i class="fas fa-star"></i> Carregando...</span>
                </p>
                <div class="share-button">
                    <button><img src="https://via.placeholder.com/20x20?text=üîó" alt="Compartilhar"> Compartilhar</button>
                </div>
            </div>
        </div>

        <section class="description-section">
            <h3>Descri√ß√£o do Servi√ßo</h3>
            <p>Selecione abaixo a data, hor√°rio e tipo de servi√ßo desejado para agendar com o profissional. Nossa equipe √© composta por profissionais qualificados e experientes, prontos para atender √†s suas necessidades com carinho e dedica√ß√£o.</p>
            <a href="#" class="read-more">Ler mais</a>
        </section>

        <form id="agendamento-form">
            <section class="scheduling-section">
                <!-- Se√ß√µes de data e hor√°rio continuam as mesmas -->
                <h3>Selecione uma data</h3>
                <div class="date-picker">
                    <button type="button" class="arrow" id="prev-date">&lt;</button>
                    <div class="date-items" id="date-items-container"></div>
                    <button type="button" class="arrow" id="next-date">&gt;</button>
                </div>

                <h3>Selecione um hor√°rio</h3>
                <div class="time-picker">
                    <button type="button" class="arrow" id="prev-time">&lt;</button>
                    <div class="time-items" id="time-items-container"></div>
                    <button type="button" class="arrow" id="next-time">&gt;</button>
                </div>
            </section>

            <section class="service-selection-section">
                <h3>Selecione um tipo de servi√ßo</h3>
                <!--
                  MUDAN√áA PRINCIPAL: Este container agora est√° vazio.
                  O JavaScript ir√° preench√™-lo com os servi√ßos buscados da API.
                -->
                <div class="service-selection-container" id="service-cards-container">
                    <!-- Os servi√ßos do profissional ser√£o carregados aqui dinamicamente -->
                </div>

                <div class="total-price-section">
                    <p class="total-label">Subtotal:</p>
                    <p class="total-value" id="subtotal-value">R$ 0,00</p>
                    <button type="submit" class="buy-button" id="btn-continuar">Continuar</button>
                </div>
            </section>
        </form>

        <section class="payment-methods-section">
            <!-- Se√ß√£o de pagamento continua a mesma -->
            <h3>M√©todos de pagamento</h3>
            <div class="payment-icons">
                <img src="https://via.placeholder.com/50x30?text=VISA" alt="Visa">
                <img src="https://via.placeholder.com/50x30?text=MASTERCARD" alt="Mastercard">
                <img src="https://via.placeholder.com/50x30?text=PIX" alt="Pix">
            </div>
            <a href="#" class="more-options">Ver mais op√ß√µes</a>
        </section>
    </div>
</main>

<footer class="footer">
    <!-- Footer continua o mesmo -->
    <div class="container footer-content">
        <div class="security-info">
            <h4>Compre com total seguran√ßa</h4>
            <p>Os dados pessoais s√£o criptografados e protegidos.</p>
        </div>
        <div class="help-info">
            <h4>Precisando de ajuda?</h4>
            <p>Acesse nossa Central de Ajuda ou entre em contato.</p>
            <a href="#">Fale conosco</a>
        </div>
    </div>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURA√á√ÉO DAS URLs DA API ---
        const AGENDAMENTO_API_URL = 'http://localhost:8080/api/agendamento';
        const SERVICOS_API_URL = 'http://localhost:8080/api/servico';

        // --- MOCK DE DADOS DO PROFISSIONAL (SIMULA√á√ÉO) ---
        // Mantenha isso para carregar o perfil do profissional.
        const mockProfissionais = {
            '1': { id: 1, nome: 'Ana Costa', especialidade: 'Cuidadora de Idosos', localizacao: 'Belo Horizonte, MG', registro: 'Certificado Profissional', avaliacao: '4.9 (87 Avalia√ß√µes)', imagemUrl: 'https://images.pexels.com/photos/4270088/pexels-photo-4270088.jpeg?auto=compress&cs=tinysrgb&w=600' },
            '2': { id: 2, nome: 'Carlos Andrade', especialidade: 'Enfermeiro Domiciliar', localizacao: 'Contagem, MG', registro: 'COREN-MG 123.456', avaliacao: '5.0 (112 Avalia√ß√µes)', imagemUrl: 'https://images.pexels.com/photos/5215024/pexels-photo-5215024.jpeg?auto=compress&cs=tinysrgb&w=600' }
        };

        async function getProfessionalById(id) {
            return new Promise(resolve => setTimeout(() => resolve(mockProfissionais[id]), 200));
        }

        // --- SELE√á√ÉO DOS ELEMENTOS DO DOM ---
        const agendamentoForm = document.getElementById('agendamento-form');
        const dateContainer = document.getElementById('date-items-container');
        const timeContainer = document.getElementById('time-items-container');
        const serviceCardsContainer = document.getElementById('service-cards-container'); // Container din√¢mico
        const subtotalValueElement = document.getElementById('subtotal-value');

        // Elementos do card do profissional
        const professionalImage = document.getElementById('professional-image');
        const professionalName = document.getElementById('professional-name');
        const professionalSpecialty = document.getElementById('professional-specialty');
        const professionalLocation = document.getElementById('professional-location');
        const professionalRegistry = document.getElementById('professional-registry');
        const professionalRating = document.getElementById('professional-rating');

        // --- ESTADO DO AGENDAMENTO ---
        let agendamentoState = {
            data: null,
            horario: null,
            servicoSelecionado: null, // Armazena o objeto do servi√ßo completo
            idProfissional: null
        };

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO E L√ìGICA ---

        function populateProfessionalCard(professional) {
            professionalImage.src = professional.imagemUrl;
            professionalName.textContent = professional.nome;
            professionalSpecialty.innerHTML = `<i class="fas fa-user-md"></i> ${professional.especialidade}`;
            professionalLocation.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${professional.localizacao}`;
            professionalRegistry.innerHTML = `<i class="fas fa-id-card"></i> ${professional.registro}`;
            professionalRating.innerHTML = `<i class="fas fa-star"></i> ${professional.avaliacao}`;
        }

        function populateDates() { /* ...c√≥digo para popular datas permanece o mesmo... */
            dateContainer.innerHTML = '';
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                if (date.getDay() === 0) continue;
                const dayOfWeek = date.toLocaleDateString('pt-BR', { weekday: 'short' }).slice(0,3);
                const dayOfMonth = date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                const dateValue = date.toISOString().split('T')[0];
                const dateItem = document.createElement('div');
                dateItem.classList.add('date-item');
                dateItem.setAttribute('data-date', dateValue);
                dateItem.innerHTML = `<span class="day-of-week">${dayOfWeek}</span><span class="day-of-month">${dayOfMonth.replace('.', '')}</span>`;
                dateContainer.appendChild(dateItem);
            }
        }

        function populateTimes() { /* ...c√≥digo para popular hor√°rios permanece o mesmo... */
            timeContainer.innerHTML = '';
            const horarios = ['09:30', '10:30', '11:30', '13:30', '14:30', '15:30', '16:30', '17:30'];
            horarios.forEach(horario => {
                const timeItem = document.createElement('div');
                timeItem.classList.add('time-item');
                timeItem.innerHTML = `<span class="time">${horario}</span>`;
                timeContainer.appendChild(timeItem);
            });
        }

        function updateSubtotal() {
            const valor = agendamentoState.servicoSelecionado ? agendamentoState.servicoSelecionado.preco : 0;
            subtotalValueElement.textContent = valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        /**
         * NOVO: Carrega os servi√ßos da API e os exibe na tela.
         */
        async function carregarServicos() {
            try {
                const response = await fetch(SERVICOS_API_URL);
                if (!response.ok) throw new Error('Falha ao buscar servi√ßos.');

                const servicos = await response.json();
                serviceCardsContainer.innerHTML = ''; // Limpa o container

                servicos.forEach(servico => {
                    const card = document.createElement('div');
                    card.className = 'service-type-card';
                    // Armazena os dados do servi√ßo no pr√≥prio elemento
                    card.dataset.serviceId = servico.id;
                    card.dataset.serviceNome = servico.nome;
                    card.dataset.servicePreco = servico.preco;

                    card.innerHTML = `
                    <h4>${servico.nome.toUpperCase()}</h4>
                    <p class="price">A partir de ${Number(servico.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                    <div class="details">
                        <p>${servico.descricao}</p>
                    </div>
                    <button type="button" class="add-to-cart">Adicionar</button>
                `;
                    serviceCardsContainer.appendChild(card);
                });

            } catch (error) {
                console.error("Erro ao carregar servi√ßos:", error);
                serviceCardsContainer.innerHTML = `<p style="color: red;">N√£o foi poss√≠vel carregar os servi√ßos dispon√≠veis.</p>`;
            }
        }

        // --- EVENT LISTENERS (A√á√ïES DO USU√ÅRIO) ---

        dateContainer.addEventListener('click', (event) => { /* ...l√≥gica de data permanece a mesma... */
            const target = event.target.closest('.date-item');
            if (!target) return;
            dateContainer.querySelector('.selected')?.classList.remove('selected');
            target.classList.add('selected');
            agendamentoState.data = target.getAttribute('data-date');
        });

        timeContainer.addEventListener('click', (event) => { /* ...l√≥gica de hor√°rio permanece a mesma... */
            const target = event.target.closest('.time-item');
            if (!target) return;
            timeContainer.querySelector('.selected')?.classList.remove('selected');
            target.classList.add('selected');
            agendamentoState.horario = target.querySelector('.time').textContent;
        });

        /**
         * MUDAN√áA: Usa delega√ß√£o de eventos para lidar com cliques nos cards de servi√ßo
         * que foram criados dinamicamente.
         */
        serviceCardsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('add-to-cart')) {
                const card = event.target.closest('.service-type-card');
                if (!card) return;

                // Remove a sele√ß√£o de outros cards
                serviceCardsContainer.querySelector('.selected')?.classList.remove('selected');
                // Adiciona a sele√ß√£o ao card clicado
                card.classList.add('selected');

                // Atualiza o estado do agendamento com os dados do card
                agendamentoState.servicoSelecionado = {
                    id: card.dataset.serviceId,
                    nome: card.dataset.serviceNome,
                    preco: parseFloat(card.dataset.servicePreco)
                };

                updateSubtotal();
            }
        });

        // Evento de submiss√£o do formul√°rio
        agendamentoForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (!agendamentoState.data || !agendamentoState.horario || !agendamentoState.servicoSelecionado) {
                alert('Por favor, selecione data, hor√°rio e um tipo de servi√ßo.');
                return;
            }
            if (!agendamentoState.idProfissional) {
                alert('Erro: ID do profissional n√£o encontrado. Volte e selecione um profissional novamente.');
                return;
            }

            // Objeto a ser enviado para o backend
            const agendamentoParaSalvar = {
                dataAgendamento: agendamentoState.data,
                horarioAgendamento: agendamentoState.horario,
                tipoServico: agendamentoState.servicoSelecionado.nome, // Envia o nome do servi√ßo
                valor: agendamentoState.servicoSelecionado.preco,      // Envia o pre√ßo
                status: 'PENDENTE',
                idProfissional: agendamentoState.idProfissional
                // idCliente: 1, // Voc√™ precisar√° obter o ID do cliente logado
            };

            console.log('Enviando para o backend:', JSON.stringify(agendamentoParaSalvar));

            try {
                const response = await fetch(AGENDAMENTO_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agendamentoParaSalvar),
                });
                if (!response.ok) throw new Error('Falha na requisi√ß√£o: ' + response.statusText);

                const data = await response.json();
                alert(`Agendamento #${data.id} realizado com sucesso para ${professionalName.textContent}!`);
                location.reload();
            } catch (error) {
                console.error('Erro ao salvar agendamento:', error);
                alert('N√£o foi poss√≠vel realizar o agendamento. Verifique se o servidor backend est√° ativo e tente novamente.');
            }
        });

        // --- INICIALIZA√á√ÉO DA P√ÅGINA ---
        async function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            const professionalId = urlParams.get('id');

            if (!professionalId) {
                document.querySelector('.main-content').innerHTML = '<h1>Erro: Nenhum profissional selecionado.</h1><p>Por favor, volte √† p√°gina anterior e escolha um profissional para agendar.</p>';
                return;
            }

            try {
                const professionalData = await getProfessionalById(professionalId);
                populateProfessionalCard(professionalData);
                agendamentoState.idProfissional = professionalData.id;

                // Carrega as informa√ß√µes din√¢micas
                await carregarServicos(); // NOVO
                populateDates();
                populateTimes();

            } catch (error) {
                document.querySelector('.main-content').innerHTML = `<h1>Erro: Profissional n√£o encontrado.</h1><p>${error}</p>`;
            }
        }

        initializePage();
    });
</script>
</body>
</html>
