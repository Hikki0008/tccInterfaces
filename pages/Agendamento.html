<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgeCare - Agendamento</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assents/css/Agendamento.css">
    <style>
        /* Estilo b√°sico para a classe 'selected' que o JavaScript adiciona */
        .date-item.selected, .time-item.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .service-type-card.selected {
            border: 2px solid #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
        }
    </style>
</head>
<body>
<header class="header">
    <div class="container header-content">
        <div class="logo-container">
            <i class="fas fa-heartbeat logo-icon"></i>
            <h1 class="logo-text">AgeCare</h1>
        </div>
        <nav class="nav">
            <ul>
                <li><a href="#" title="In√≠cio"><i class="fas fa-home"></i></a></li>
                <li><a href="#" title="Agendamentos"><i class="fas fa-calendar-alt"></i></a></li>
                <li><a href="#" title="Favoritos"><i class="fas fa-heart"></i></a></li>
                <li><a href="#" title="Mensagens"><i class="fas fa-comments"></i></a></li>
                <li><a href="#" title="Notifica√ß√µes"><i class="fas fa-bell"></i></a></li>
                <li><a href="#" title="Minha Conta"><i class="fas fa-user-circle"></i></a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="main-content">
    <div class="container">
        
        <div class="service-details-card" id="professional-card">
            <div class="service-image">
                <img id="professional-image" src="https://via.placeholder.com/300x200?text=Carregando..." alt="Foto do Profissional">
            </div>
            <div class="service-info">
                <h2 id="professional-name">Carregando...</h2>
                <p class="service-meta">
                    <span id="professional-specialty"><i class="fas fa-user-md"></i> Carregando...</span> <br>
                    <span id="professional-location"><i class="fas fa-map-marker-alt"></i> Carregando...</span> <br>
                    <span id="professional-registry"><i class="fas fa-id-card"></i> Carregando...</span> <br>
                    <span id="professional-rating"><i class="fas fa-star"></i> Carregando...</span>
                </p>
                <div class="share-button">
                    <button><img src="https://via.placeholder.com/20x20?text=üîó" alt="Compartilhar"> Compartilhar</button>
                </div>
            </div>
        </div>

        <section class="description-section">
            <h3>Descri√ß√£o do Servi√ßo</h3>
            <p>Selecione abaixo a data, hor√°rio e tipo de servi√ßo desejado para agendar com o profissional. Nossa equipe √© composta por profissionais qualificados e experientes, prontos para atender √†s suas necessidades com carinho e dedica√ß√£o.</p>
            <a href="#" class="read-more">Ler mais</a>
        </section>

        <form id="agendamento-form">
            <section class="scheduling-section">
                <h3>Selecione uma data</h3>
                <div class="date-picker">
                    <button type="button" class="arrow" id="prev-date">&lt;</button>
                    <div class="date-items" id="date-items-container"></div>
                    <button type="button" class="arrow" id="next-date">&gt;</button>
                </div>

                <h3>Selecione um hor√°rio</h3>
                <div class="time-picker">
                     <button type="button" class="arrow" id="prev-time">&lt;</button>
                    <div class="time-items" id="time-items-container"></div>
                    <button type="button" class="arrow" id="next-time">&gt;</button>
                </div>
            </section>

            <section class="service-selection-section">
                <h3>Selecione um tipo de servi√ßo</h3>
                <div class="service-selection-container">
                    <div class="service-type-card" data-service="CUIDADOR" data-price="80">
                        <h4>CUIDADOR</h4>
                        <p class="price">A partir de R$ 80,00 / hora</p>
                        <div class="details">
                            <p>Ideal para suporte e companhia nas atividades di√°rias.</p>
                            <ul class="service-duties">
                                <li>‚úì Aux√≠lio com higiene e vestu√°rio</li>
                                <li>‚úì Companhia e atividades de lazer</li>
                            </ul>
                        </div>
                        <button type="button" class="add-to-cart">Adicionar</button>
                    </div>
                    <div class="service-type-card" data-service="ENFERMEIRO" data-price="150">
                        <h4>ENFERMEIRO(A)</h4>
                        <p class="price">A partir de R$ 150,00 / hora</p>
                        <div class="details">
                            <p>Para cuidados que exigem conhecimento t√©cnico.</p>
                            <ul class="service-duties">
                                <li>‚úì Aplica√ß√£o de medicamentos (injet√°veis, etc.)</li>
                                <li>‚úì Realiza√ß√£o de curativos complexos</li>
                            </ul>
                        </div>
                        <button type="button" class="add-to-cart">Adicionar</button>
                    </div>
                </div>

                <div class="total-price-section">
                    <p class="total-label">Subtotal:</p>
                    <p class="total-value" id="subtotal-value">R$ 0,00</p>
                    <button type="submit" class="buy-button" id="btn-continuar">Continuar</button>
                </div>
            </section>
        </form>

        <section class="payment-methods-section">
            <h3>M√©todos de pagamento</h3>
            <div class="payment-icons">
                <img src="https://via.placeholder.com/50x30?text=VISA" alt="Visa">
                <img src="https://via.placeholder.com/50x30?text=MASTERCARD" alt="Mastercard">
                <img src="https://via.placeholder.com/50x30?text=PIX" alt="Pix">
            </div>
            <a href="#" class="more-options">Ver mais op√ß√µes</a>
        </section>
    </div>
</main>

<footer class="footer">
    <div class="container footer-content">
        <div class="security-info">
            <h4>Compre com total seguran√ßa</h4>
            <p>Os dados pessoais s√£o criptografados e protegidos.</p>
        </div>
        <div class="help-info">
            <h4>Precisando de ajuda?</h4>
            <p>Acesse nossa Central de Ajuda ou entre em contato.</p>
            <a href="#">Fale conosco</a>
        </div>
    </div>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- MOCK DE DADOS (SIMULA√á√ÉO DO BACKEND) ---
    // Em uma aplica√ß√£o real, estes dados viriam do seu backend.
    const mockProfissionais = {
        '1': {
            id: 1,
            nome: 'Ana Costa',
            especialidade: 'Cuidadora de Idosos',
            localizacao: 'Belo Horizonte, MG',
            registro: 'Certificado de Cuidadora Profissional',
            avaliacao: '4.9 (87 Avalia√ß√µes)',
            imagemUrl: 'https://images.pexels.com/photos/4270088/pexels-photo-4270088.jpeg?auto=compress&cs=tinysrgb&w=600'
        },
        '2': {
            id: 2,
            nome: 'Carlos Andrade',
            especialidade: 'Enfermeiro Domiciliar',
            localizacao: 'Contagem, MG',
            registro: 'COREN-MG 123.456',
            avaliacao: '5.0 (112 Avalia√ß√µes)',
            imagemUrl: 'https://images.pexels.com/photos/5215024/pexels-photo-5215024.jpeg?auto=compress&cs=tinysrgb&w=600'
        }
    };
    
    // Fun√ß√£o que simula a busca no banco de dados
    async function getProfessionalById(id) {
        // Em um projeto real:
        // const response = await fetch(`/api/profissionais/${id}`);
        // return await response.json();
        
        // Simula√ß√£o para este exemplo:
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (mockProfissionais[id]) {
                    resolve(mockProfissionais[id]);
                } else {
                    reject('Profissional n√£o encontrado');
                }
            }, 500); // Simula a demora da rede
        });
    }

    // --- SELE√á√ÉO DOS ELEMENTOS DO DOM ---
    const agendamentoForm = document.getElementById('agendamento-form');
    const dateContainer = document.getElementById('date-items-container');
    const timeContainer = document.getElementById('time-items-container');
    const serviceCards = document.querySelectorAll('.service-type-card');
    const subtotalValueElement = document.getElementById('subtotal-value');
    
    // Seletores para o novo card do profissional
    const professionalImage = document.getElementById('professional-image');
    const professionalName = document.getElementById('professional-name');
    const professionalSpecialty = document.getElementById('professional-specialty');
    const professionalLocation = document.getElementById('professional-location');
    const professionalRegistry = document.getElementById('professional-registry');
    const professionalRating = document.getElementById('professional-rating');

    // --- ESTADO DO AGENDAMENTO ---
    let agendamentoState = {
        data: null,
        horario: null,
        tipoServico: null,
        valor: 0.0,
        idProfissional: null
    };

    // --- FUN√á√ïES AUXILIARES ---

    // Preenche o card do profissional com os dados buscados
    function populateProfessionalCard(professional) {
        professionalImage.src = professional.imagemUrl;
        professionalName.textContent = professional.nome;
        professionalSpecialty.innerHTML = `<i class="fas fa-user-md"></i> ${professional.especialidade}`;
        professionalLocation.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${professional.localizacao}`;
        professionalRegistry.innerHTML = `<i class="fas fa-id-card"></i> ${professional.registro}`;
        professionalRating.innerHTML = `<i class="fas fa-star"></i> ${professional.avaliacao}`;
    }

    // Gera dinamicamente os pr√≥ximos 7 dias √∫teis
    function populateDates() {
        dateContainer.innerHTML = '';
        const today = new Date();
        for (let i = 0; i < 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);

            if (date.getDay() === 0) continue; // Pula Domingos

            const dayOfWeek = date.toLocaleDateString('pt-BR', { weekday: 'short' }).slice(0,3);
            const dayOfMonth = date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
            const dateValue = date.toISOString().split('T')[0];

            const dateItem = document.createElement('div');
            dateItem.classList.add('date-item');
            dateItem.setAttribute('data-date', dateValue);
            dateItem.innerHTML = `<span class="day-of-week">${dayOfWeek}</span><span class="day-of-month">${dayOfMonth.replace('.', '')}</span>`;
            dateContainer.appendChild(dateItem);
        }
    }

    // Gera os hor√°rios dispon√≠veis
    function populateTimes() {
        timeContainer.innerHTML = '';
        const horarios = ['09:30', '10:30', '11:30', '13:30', '14:30', '15:30', '16:30', '17:30'];
        horarios.forEach(horario => {
            const timeItem = document.createElement('div');
            timeItem.classList.add('time-item');
            timeItem.innerHTML = `<span class="time">${horario}</span>`;
            timeContainer.appendChild(timeItem);
        });
    }
    
    // Atualiza o valor do subtotal na tela
    function updateSubtotal() {
        subtotalValueElement.textContent = agendamentoState.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    // --- EVENT LISTENERS (A√á√ïES DO USU√ÅRIO) ---

    dateContainer.addEventListener('click', (event) => {
        const target = event.target.closest('.date-item');
        if (!target) return;
        dateContainer.querySelector('.selected')?.classList.remove('selected');
        target.classList.add('selected');
        agendamentoState.data = target.getAttribute('data-date');
    });

    timeContainer.addEventListener('click', (event) => {
        const target = event.target.closest('.time-item');
        if (!target) return;
        timeContainer.querySelector('.selected')?.classList.remove('selected');
        target.classList.add('selected');
        agendamentoState.horario = target.querySelector('.time').textContent;
    });

    serviceCards.forEach(card => {
        card.querySelector('.add-to-cart').addEventListener('click', () => {
            serviceCards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            agendamentoState.tipoServico = card.getAttribute('data-service');
            agendamentoState.valor = parseFloat(card.getAttribute('data-price'));
            updateSubtotal();
        });
    });

    // Evento de submiss√£o do formul√°rio
    agendamentoForm.addEventListener('submit', async (event) => {
        event.preventDefault(); // Impede recarregamento da p√°gina

        if (!agendamentoState.data || !agendamentoState.horario || !agendamentoState.tipoServico) {
            alert('Por favor, selecione data, hor√°rio e um tipo de servi√ßo.');
            return;
        }
        if (!agendamentoState.idProfissional) {
            alert('Erro: ID do profissional n√£o encontrado. Volte e selecione um profissional novamente.');
            return;
        }

        // Objeto a ser enviado para o backend
        const agendamentoParaSalvar = {
            dataAgendamento: agendamentoState.data,
            horarioAgendamento: agendamentoState.horario,
            tipoServico: agendamentoState.tipoServico,
            valor: agendamentoState.valor,
            status: 'PENDENTE',
            idProfissional: agendamentoState.idProfissional
            // idCliente: 1, // Voc√™ precisar√° obter o ID do cliente logado
        };
        
        console.log('Enviando para o backend:', JSON.stringify(agendamentoParaSalvar));

        // Requisi√ß√£o FETCH para o backend
        try {
            const response = await fetch('/api/agendamento', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(agendamentoParaSalvar),
            });
            if (!response.ok) throw new Error('Falha na requisi√ß√£o: ' + response.statusText);
            
            const data = await response.json();
            alert(`Agendamento #${data.id} realizado com sucesso para ${professionalName.textContent}!`);
            location.reload(); // Recarrega a p√°gina para limpar
        } catch (error) {
            console.error('Erro ao salvar agendamento:', error);
            // Alerta para quando o backend n√£o est√° rodando
            alert('N√£o foi poss√≠vel realizar o agendamento. Verifique se o servidor backend est√° ativo e tente novamente.');
        }
    });

    // --- INICIALIZA√á√ÉO DA P√ÅGINA ---
    async function initializePage() {
        const urlParams = new URLSearchParams(window.location.search);
        const professionalId = urlParams.get('id');

        if (!professionalId) {
            document.querySelector('.main-content').innerHTML = '<h1>Erro: Nenhum profissional selecionado.</h1><p>Por favor, volte √† p√°gina anterior e escolha um profissional para agendar.</p>';
            return;
        }

        try {
            const professionalData = await getProfessionalById(professionalId);
            populateProfessionalCard(professionalData);
            agendamentoState.idProfissional = professionalData.id;
            populateDates();
            populateTimes();
        } catch (error) {
            document.querySelector('.main-content').innerHTML = `<h1>Erro: Profissional n√£o encontrado.</h1><p>${error}</p>`;
        }
    }

    initializePage();
});
</script>
</body>
</html>